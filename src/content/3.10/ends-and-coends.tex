% !TEX root = ../../ctfp-print.tex

\lettrine[lhang=0.17]{圏}{における}射に対して様々な直観を持つことができますが、対象$a$から対象$b$への射がある場合、両対象は何らかの方法で「関連している」ということについては全員が同意するでしょう。射は、この関係の証明であるという意味で、任意の半順序集合の圏では、射が関係そのものです。一般的に、二つの対象間の同じ関係の「証明」は多数存在することがあります。これらの証明は、ホム集合と呼ばれる集合を形成します。対象が変わると、対象のペアから「証明」の集合へのマッピングが得られます。このマッピングは関手的であり、第一引数に反変で第二引数に共変です。これを圏の対象間の大局的な関係を確立していると見なすことができます。この関係はホム関手によって記述されます: 
\[\cat{C}(-, =) \Colon \cat{C}^\mathit{op}\times{}\cat{C} \to \Set\]
一般に、このような関手は、圏の対象間の関係を確立すると解釈することができます。関係は、異なる二つの圏$\cat{C}$と$\cat{D}$を巻き込むこともあります。このような関係を記述する関手は、次のシグネチャを持ち、プロ関手と呼ばれます: 
\[p \Colon \cat{D}^\mathit{op}\times{}\cat{C} \to \Set\]
数学者は、これを$\cat{C}$から$\cat{D}$へのプロ関手 (注目してください、反転しています) と言い、そのシンボルとして斜線が付いた矢印を使います: 
\[\cat{C} \nrightarrow \cat{D}\]
プロ関手は、$\cat{C}$の対象と$\cat{D}$の対象の間の\newterm{証明関連関係}と考えることができます。ここで、集合の要素は関係の証明を象徴しています。いつ$p\ a\ b$が空であるならば、$a$と$b$の間には関係がありません。関係は対称的である必要はないことに注意してください。

もう一つの有用な直観は、自己関手がコンテナであるという考えの一般化です。プロ関手の値$p\ a\ b$は、型$a$の要素によってキー付けされた$b$のコンテナと見なすことができます。特に、ホムプロ関手の要素は$a$から$b$への関数です。

Haskellでは、プロ関手は二引数の型コンストラクタ\code{p}と、ペアの関数を持ち上げると呼ばれるメソッド\code{dimap}で定義されます。最初の関数は「間違った方向」に行きます: 

\src{snippet01}
プロ関手の関手性は、もし\code{a}が\code{b}に関連している証明があれば、\code{c}が\code{d}に関連している証明を得ることができると教えてくれます。ただし、\code{c}から\code{a}への射と、\code{b}から\code{d}への別の射がある場合です。あるいは、最初の関数を新しいキーを古いキーに翻訳するものとし、二つ目の関数をコンテナの内容を変更するものとして考えることもできます。

一つの圏内で作用するプロ関手については、型$p\ a\ a$の対角要素からかなりの情報を抽出することができます。射のペア$b \to a$と$a \to c$がある限り、$b$が$c$に関連していることを証明することができます。さらに良いことに、単一の射を使って対角線の値に達することができます。例えば、射$f \Colon a \to b$がある場合、ペア$\langle f, \idarrow[b] \rangle$を持ち上げて$p\ b\ b$から$p\ a\ b$へ行くことができます: 

\src{snippet02}
または、ペア$\langle \idarrow[a], f \rangle$を持ち上げて$p\ a\ a$から$p\ a\ b$へ行くことができます: 

\src{snippet03}

\section{双自然変換}

プロ関手は関手なので、標準的な方法でそれらの間の自然変換を定義することができます。多くの場合、二つのプロ関手の対角要素の間のマッピングを定義するだけで十分です。このような変換は、対角要素を非対角要素に接続する二つの方法を反映した可換性条件を満たす場合、双自然変換と呼ばれます。プロ関手$p$と$q$の間の双自然変換は、関手圏${[}\cat{C}^\mathit{op}\times{}\cat{C}, \Set{]}$のメンバーである変換の形態族です: 
\[\alpha_a \Colon p\ a\ a \to q\ a\ a\]
以下の図の通り、任意の射$f \Colon a \to b$に対して以下の図が可換であること: 

\begin{figure}[H]
  \centering
  \includegraphics[width=0.35\textwidth]{images/end.jpg}
\end{figure}

\noindent
この条件は自然性条件よりも明らかに弱いです。もし$\alpha$が${[}\cat{C}^\mathit{op}\times{}\cat{C}, \Set{]}$における自然変換であれば、上記の図は二つの自然性の四角形と一つの関手性条件 (プロ関手$q$が合成を保存する) から構成されます: 

\begin{figure}[H]
  \centering
  \includegraphics[width=0.4\textwidth]{images/end-1.jpg}
\end{figure}

\noindent
${[}\cat{C}^\mathit{op}\times{}\cat{C}, \Set{]}$における自然変換$\alpha$のコンポーネントは対象のペアによってインデックス付けされます$\alpha_{a b}$。一方、双自然変換は、それが対応するプロ関手の対角要素のみをマッピングするので、一つの対象によってインデックス付けされます。

\section{エンド}

「代数」から「微積分」に進む準備ができました。エンド (および余エンド) の微積分は、伝統的な微積分からアイデアといくつかの表記を借りています。特に、余エンドは無限和または積分として理解されるかもしれませんが、エンドは無限積に似ています。Diracのデルタ関数のようなものさえあります。

エンドは極限の一般化であり、関手に代わってプロ関手があります。錐体に代わって、私たちはくさびを持っています。くさびの底はプロ関手$p$の対角要素によって形成されます。くさびの頂点は対象 (ここでは、$\Set$値のプロ関手を考慮しているので、集合) であり、側面は頂点から底部の集合への関数の族です。この族を一つの多相的関数と考えることができます --- その戻り型が多相的な関数です: 
\[\alpha \Colon \forall a\ .\ \mathit{apex} \to p\ a\ a\]
錐体とは異なり、くさび内には基部の頂点を接続する関数はありません。しかし、私たちが以前見たように、$\cat{C}$の中の任意の射$f \Colon a \to b$を与えられると、私たちは$p\ a\ a$と$p\ b\ b$の両方を共通の集合$p\ a\ b$に接続することができます。したがって、次の図が可換であることを主張します: 

\begin{figure}[H]
  \centering
  \includegraphics[width=0.4\textwidth]{images/end-2.jpg}
\end{figure}

\noindent
これは\newterm{くさび条件}と呼ばれます。これは次のように書くことができます: 
\[p\ \idarrow[a]\ f \circ \alpha_a = p\ f\ \idarrow[b] \circ \alpha_b\]
あるいは、Haskell表記を使って: 

\src{snippet04}
これで私たちは、普遍構成を用いて、$p$のエンドを普遍くさびとして定義することができます --- 一つの集合$e$と一つの関数の族$\pi$を持つもので、任意の他のくさびが頂点$a$と一つの族$\alpha$を持つ場合、全ての三角形を可換にする一意な関数$h \Colon a \to e$が存在します: 
\[\pi_a \circ h = \alpha_a\]

\begin{figure}[H]
  \centering
  \includegraphics[width=0.4\textwidth]{images/end-21.jpg}
\end{figure}

\noindent
エンドのシンボルは積分符号であり、「積分変数」は添字位置にあります: 
\[\int_c p\ c\ c\]
$\pi$のコンポーネントはエンドのための射影マップと呼ばれます: 
\[\pi_a \Colon \int_c p\ c\ c \to p\ a\ a\]
$\cat{C}$が離散圏 (恒等射以外の射がない) である場合、エンドは$p$の全ての対角要素の全体的な積です。後で、もう少し一般的なケースでは、エンドとこの積との間にイコライザを通じて関係があることを示します。

Haskellでは、エンドの式は全称量化子に直接翻訳されます: 

\src{snippet05}
厳密に言えば、これは$p$の全ての対角要素のただの積ですが、くさび条件は\urlref{https://bartoszmilewski.com/2017/04/11/profunctor-parametricity/}{パラメトリシティ}により自動的に満たされます。任意の関数$f \Colon a \to b$に対して、くさび条件は以下のようになります: 

\src{snippet06}
または、型注釈付きで: 

\begin{snipv}
dimap f id\textsubscript{b} . pi\textsubscript{b} = dimap id\textsubscript{a} f . pi\textsubscript{a}
\end{snipv}
ここで、方程式の両側は型: 

\src{snippet07}
を持ち、\code{pi}は多相的射影です: 

\src{snippet08}
ここで、型推論は自動的に\code{e}の正しいコンポーネントを選択します。

錐体のための全ての可換性条件を一つの自然変換として表現することができたのと同様に、くさび条件を一つの双自然変換にまとめることができます。そのためには、全ての対象のペアを単一の対象$c$にマッピングし、全ての射のペアをこの対象の恒等射にマッピングする定数関手$\Delta_c$への定数プロ関手の一般化が必要です。くさびはその関手からプロ関手$p$への双自然変換です。実際には、双自然変換の六角形は、$\Delta_c$が全ての射を一つの恒等関数に持ち上げるときにくさびダイアモンドに縮小します。

エンドは$\Set$以外のターゲット圏に対しても定義することができますが、ここでは$\Set$-値のプロ関手とそのエンドのみを考慮します。

\section{エンドとイコライザとして}

エンドの定義における可換性条件はイコライザを使って書くことができます。まず、Haskellの表記を使用して (数学的な表記はこの場合ユーザーフレンドリーでないようです) 、くさび条件の二つの収束する枝に対応する二つの関数を定義しましょう: 

\src{snippet09}[b]
両方の関数はプロ関手\code{p}の対角要素を型: 

\src{snippet10}
の多相的関数にマップします。

これらの関数は異なる型を持っています。しかし、\code{p}の全ての対角要素を集める一つの大きな積型を形成することにより、その型を統一することができます: 

\src{snippet11}
関数\code{lambda}と\code{rho}はこの積型から二つのマッピングを誘導します: 

\src{snippet12}
\code{p}のエンドはこれら二つの関数のイコライザです。イコライザは二つの関数が等しい最大の部分集合を選び出します。この場合、それはくさびダイアグラムが可換になるための\code{p}の全ての対角要素の積の部分集合を選び出します。

\section{自然変換としてのエンド}

エンドの最も重要な例は、自然変換の集合です。二つの関手$F$と$G$の間の自然変換は、形式$\cat{C}(F a, G a)$のホム集合から選ばれる射の族です。自然性条件がなければ、自然変換の集合はこれらのホム集合の全ての積に過ぎません。実際、Haskellではそれがそうです: 

\src{snippet13}
Haskellでうまくいく理由は、自然性がパラメトリシティによって従うからです。しかし、Haskellの外では、そのようなホム集合を横断する全ての対角セクションが自然変換を生み出すわけではありません。しかし、注意してください: 
\[\langle a, b \rangle \to \cat{C}(F a, G b)\]
はプロ関手なので、そのエンドを研究することは意味があります。これがくさび条件です: 

\begin{figure}[H]
  \centering
  \includegraphics[width=0.4\textwidth]{images/end1.jpg}
\end{figure}

\noindent
集合$\int_c \cat{C}(F c, G c)$から一つの要素を選び出しましょう。二つの射影はこの要素を特定の変換の二つのコンポーネントにマップします。それらを呼びましょう: 
\begin{align*}
  \tau_a & \Colon F a \to G a \\
  \tau_b & \Colon F b \to G b
\end{align*}
左の枝では、ペアの射$\langle \idarrow[a], G f \rangle$をホム関手で持ち上げます。そのような持ち上げは同時に前置きと後置きの合成として実装されることを思い出してください。$\tau_a$に作用する持ち上げられたペアは次のようになります: 
\[G f \circ \tau_a \circ \idarrow[a]\]
図の他の枝は次のようになります: 
\[\idarrow[b] \circ \tau_b \circ F f\]
くさび条件によって要求される彼らの等式は、$\tau$の自然性条件に他なりません。

\section{余エンド}
予想通り、エンドの双対は余エンドと呼ばれます。これは余くさび (cowedge、コウェッジと発音されます、カウエッジではありません) と呼ばれるくさびの双対から構成されます。

\begin{figure}[H]
  \centering
  \includegraphics[width=0.25\textwidth]{images/end-31.jpg}
  \caption{エッジの効いた牛？}
\end{figure}

\noindent
余エンドのシンボルは積分符号で、「積分変数」は上付き文字の位置にあります: 
\[\int^c p\ c\ c\]
エンドが積に関連しているように、余エンドは余積、つまり和 (この点で、それは積分に似ています、それは和の極限です) に関連しています。射影の代わりに、私たちはプロ関手の対角要素から余エンドへの入射を持っています。もしくさび条件がなければ、プロ関手$p$の余エンドは$p\ a\ a$、または$p\ b\ b$、または$p\ c\ c$などのいずれかであり、またはそのような$a$が存在し、余エンドは単に集合$p\ a\ a$であると言うことができます。エンドの定義に使用された全称量化子は余エンドに対しては存在量化子になります。

このため、擬似Haskellでは、余エンドを次のように定義します: 

\begin{snip}{text}
exists a. p a a
\end{snip}
存在量化子をHaskellでエンコードする標準的な方法は、全称量化されたデータコンストラクタを使用することです。したがって、定義することができます: 

\src{snippet14}
これの背後にある論理は、任意の族の型$p\ a\ a$の値を使用して余エンドを構成できるはずです、私たちが選んだどんな$a$に関係なく。

エンドがイコライザを使って定義できるように、余エンドも\newterm{余イコライザ}を使って記述できます。全てのくさび条件は、$p\ a\ b$の全ての可能な関数$b \to a$に対する一つの巨大な余積を取ることで要約できます。Haskellでは、それは実存型として表現されます: 

\src{snippet15}
この和型は、\code{dimap}を使用して関数を持ち上げ、それをプロ関手$p$に適用することで二つの方法で評価できます: 

\src{snippet16}
ここで\code{DiagSum}は$p$の対角要素の和です: 

\src{snippet17}
これら二つの関数の余イコライザは余エンドです。余イコライザは\code{DiagSum p}から、\code{lambda}または\code{rho}を同じ引数に適用することで得られる値を識別することによって得られます。引数は関数$b \to a$と要素$p\ a\ b$のペアです。\code{lambda}と\code{rho}の適用は、型\code{DiagSum p}の二つの潜在的に異なる値を生成します。余エンドでは、これら二つの値は識別され、くさび条件が自動的に満たされます。

関連する要素を集合で識別するプロセスは、形式的には商を取ることとして知られています。商を定義するためには、\newterm{同値関係} $\sim$が必要です。関係は反射的、対称的、推移的でなければなりません: 
\begin{align*}
   & a \sim a                                                         \\
   & \text{もし}\ a \sim b\ \text{ならば}\ b \sim a                       \\
   & \text{もし}\ a \sim b\ \text{かつ}\ b \sim c\ \text{ならば}\ a \sim c
\end{align*}
このような関係は、集合を同値クラスに分割します。各クラスは互いに関連する要素で構成されます。我々は、各クラスから代表を選んで商集合を形成します。典型的な例は、以下の同値関係を持つ整数のペアの定義による有理数の定義です: 
\[(a, b) \sim (c, d)\ \text{iff}\ a * d = b * c\]
これが同値関係であることは簡単に確認できます。ペア$(a, b)$は分数$\frac{a}{b}$として解釈され、分子と分母に共通の除数がある分数は識別されます。有理数はそのような分数の同値クラスです。

我々は以前の極限と余極限の議論から、ホム関手が連続である、つまり極限を保存することを思い出してください。双対的に、反変ホム関手は余極限を極限に変換します。これらの性質はエンドと余エンドに一般化されます。エンドと余エンドはそれぞれ極限と余極限の一般化です。特に、次のような非常に便利な恒等式が得られます: 
\[\Set(\int^x p\ x\ x, c) \cong \int_x \Set(p\ x\ x, c)\]
これを擬似Haskellで見てみましょう: 

\begin{snipv}
(exists x. p x x) -> c \ensuremath{\cong} forall x. p x x -> c
\end{snipv}
これは、実存型を取る関数が多相的関数と等価であることを教えてくれます。そのような関数は、実存型にエンコードされている可能性のある任意の型を処理する準備ができていなければなりません。これは、和型を受け入れる関数がケース文として実装されなければならず、和に存在する各型に対するハンドラのタプルを持つという同じ原理です。ここでは、和型が余エンドに置き換えられ、ハンドラの族はエンド、または多相的関数になります。

\section{忍者米田の補題}

米田の補題に出てくる自然変換の集合は、エンドを使用して次のようにエンコードできます: 
\[\int_z \Set(\cat{C}(a, z), F z) \cong F a\]
また、双対の式もあります: 
\[\int^z \cat{C}(z, a)\times{}F z \cong F a\]
この恒等式は、Diracのデルタ関数 ($a = z$で無限大のピークを持つ関数$\delta(a - z)$、またはむしろ超関数) の式を強く思い起こさせます。ここでは、ホム関手がデルタ関数の役割を果たします。

これら二つの恒等式は、時々忍者米田の補題と呼ばれます。

第二の式を証明するために、任意の対象$c$へ行くホム関手の中に証明したい恒等式の左側を挿入します: 
\[\Set(\int^z \cat{C}(z, a)\times{}F z, c)\]
連続性の議論を使用して、余エンドをエンドに置き換えることができます: 
\[\int_z \Set(\cat{C}(z, a)\times{}F z, c)\]
これで、積と指数関数の間の随伴を利用することができます: 
\[\int_z \Set(\cat{C}(z, a), c^{(F z)})\]
今、積分を「実行」することができます。米田の補題を使用して次のように得られます: 
\[c^{(F a)}\]
 (ここでは、関手$c^{(F z)}$が$z$において反変であるため、米田の補題の反変版を使用しました。) 
この指数関数対象はホム集合に同型です: 
\[\Set(F a, c)\]
最後に、米田の埋め込みを利用して、次の同型に到達します: 
\[\int^z \cat{C}(z, a)\times{}F z \cong F a\]

\section{プロ関手の合成}

プロ関手が関係を記述する、より正確には証明関連関係を記述するというアイデアをさらに探求しましょう。集合$p\ a\ b$は$a$が$b$に関連している証明の集合を表します。もし私たちが二つの関係$p$と$q$を持っているなら、それらを合成してみることができます。$a$が$q$の後に$p$を介して$b$に関連していると言います。もし中間対象$c$が存在し、両方の$q\ b\ c$と$p\ c\ a$が空でない場合です。この新しい関係の証明は個々の関係の証明のペアです。したがって、存在量化子が余エンドに対応し、二つの集合のデカルト積が「証明のペア」に対応することを理解すると、次の式を使用してプロ関手の合成を定義できます: 
\[(q \circ p)\ a\ b = \int^c p\ c\ a\times{}q\ b\ c\]
これが\code{Data.Profunctor.Composition}からの同等のHaskell定義です、いくつかの名前を変更した後: 

\src{snippet18}
これは、一般化代数データ型、または\acronym{GADT}構文を使用しています。ここで自由な型変数 (ここでは\code{c}) は自動的に存在量化されます。したがって、 (非Curry化された) データコンストラクタ\code{Procompose}は次に等価です: 

\begin{snip}{text}
exists c. (q a c, p c b)
\end{snip}
定義された合成の単位はホム関手です。これは忍者米田の補題から直ちに従います。したがって、プロ関手が射として機能する圏があるかどうかを尋ねることは理にかなっています。答えは肯定的ですが、プロ関手の合成の結合性と恒等性の規則は自然同型に関してのみ成り立つという注意が必要です。このような規則が同型によってのみ成り立つ圏は、双圏 (それは$\cat{2}$-圏よりも一般的です) と呼ばれます。したがって、双圏$\cat{Prof}$があります。ここで、対象は圏であり、射はプロ関手であり、射間の射 (二セルとも呼ばれます) は自然変換です。実際、さらに進んで、通常の関手と共にプロ関手も圏間の射として持つことができます。二つの射のタイプを持つ圏は二重圏と呼ばれます。

プロ関手は、Haskellのlensライブラリやarrowライブラリで重要な役割を果たします。


